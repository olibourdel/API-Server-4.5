<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Images Manager</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
        <link rel="stylesheet"
            href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
        <link rel="stylesheet" href="css/site.css">
        <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
        <link rel="icon" href="favicon.ico">
    </head>

    <body>

        <div class="mainContainer">
            <div class="headerPanel">
                <div class="headerLayout">
                    <img id='logo' src="images/camera.png" alt="" data-toggle="tooltip" class="favicon"
                        title="Gestionnaire d'images">
                   <div style="display:flex">
                        <span class="header outLinedText tbg-yellow">
                            P
                        </span>
                        <span class="header outLinedText tbg-orange">
                            I
                        </span>
                        <span class="header outLinedText tbg-red">
                            C
                        </span>
                        <span class="header outLinedText tbg-pink ">
                            T
                        </span>
                        <span class="header outLinedText tbg-black">
                            -
                        </span>
                        <span class="header outLinedText tbg-purple">
                            C
                        </span>
                        <span class="header outLinedText tbg-blue">
                            L
                        </span>
                        <span class="header outLinedText tbg-green">
                            O
                        </span>
                        <span class="header outLinedText tbg-grass">
                            U
                        </span>
                        <span class="header outLinedText tbg-yellow">
                            D
                        </span>
                    </div>
                    <span class="cmd fa fa-plus-square loggedIn" id="newImageCmd" title="Ajouter une image"
                        data-toggle="tooltip"></span>
                    <span class="cmd fa fa-sort-amount-desc" id="sortCmd" title="Ordonner les images par date"
                        data-toggle="tooltip"></span>
                    <span class="cmd fa fa-search-plus" id="searchMenuCmd" title="Menu de recherche"
                        data-toggle="tooltip"></span>
                </div>
                <div id="accountOptions" class="account-cmd">
                    <!-- Logged In -->
                    <div id="accountAvatar">
                        <img id="accountImg" class="loggedIn avatarImg" src="images/No_Avatar.png"><img>
                    </div>
                    <!-- Logged In -->
                    <div id="accountName" class="loggedIn">
                        No-name
                    </div>
                    <div>
                        <!-- Logged Out -->
                        <span class="cmd fa fa-sign-in loggedOut" id="loginCmd" title="Se connecter"
                        data-toggle="tooltip"></span>

                        <!-- Logged In -->
                        <span class="cmd fa fa-id-card loggedIn" id="modifyAccountCmd" title="Modifier son profil"
                        data-toggle="tooltip"></span>

                    </div>
                    <div>
                        <!-- Logged Out -->
                        <span class="cmd fa fa-user-plus loggedOut" id="registerCmd" title="S'enregistrer"
                        data-toggle="tooltip"></span>

                        <!-- Logged In -->
                        <span class="cmd fa fa-sign-out loggedIn" id="disconnectCmd" title="Se déconnecter"
                        data-toggle="tooltip"></span>
                    </div>


                </div>
            </div>
            <div id="searchMenu" style="display: none;">
                <div>
                    <select id="userFilter_input" class="form-control">
                        <option value="all" selected>Tous les usagers</option>
                    </select>
                </div>
                <div>
                    <input id="keywords_input" class="form-control" type="text" list="keywordList" placeholder="Rechercher par mots-clés...">
                    <datalist id="keywordList">

                    </datalist>
                </div>
                <span class="cmd fa fa-search" id="searchCmd" title="Rechercher"
                data-toggle="tooltip"></span>
            </div>
            <div class="scrollContainer">
                <div id="imagesList">
                    <!-- filled programmatically-->
                </div>
            </div>
            <div>
                <div id="imageDlg">
                    <form id="imageForm">
                        <input type="hidden" id="Id_input" value="0">
                        <input type="hidden" id="date_input" value="0">
                        <input type="hidden" id="GUID_input" value="">

                        <label for="title_input">Titre</label>
                        <input type="text" id="title_input" class="form-control" required>

                        <label for="decription_input">Description</label>
                        <textarea id="description_input" class="form-control" required></textarea>

                        <label for="image">Image</label>
                        <div id='image' class='ImageUploader' defaultImage='images/No_Image.png'
                            waitingImage='images/writing.gif'>
                        </div>
                        <div class="note">Cliquez-Déposez une image</div>

                        <label for="shared_input">Partager</label>
                        <input type="checkbox" id="shared_input" checked>
                    </form>
                </div>

                <div id="confirmDeleteDlg">
                    <span id="confirmationMessage"></span>
                </div>

                <div id="errorDlg">
                    <span id="errorMessage"></span>
                </div>

                <div id="loginDlg">
                    <form id="loginForm">
                        <label for="loginEmail_input">Email</label>
                        <input type="text" id="loginEmail_input" class="form-control" required>

                        <label for="loginPassword_input">Mot de passe</label>
                        <input type="password" id="loginPassword_input" class="form-control" required>

                        <input type="checkbox" id="loginRememberMe_input">
                        <label for="loginRememberMe_input">Se souvenir de moi</label>
                    </form>
                </div>
                
                <div id="accountDlg">
                    <form id="accountForm">
                        <input type="hidden" id="accountId_input" value="0">

                        <input type="hidden" id="accountAvatarGuid_input" value="0">

                        <label for="accountUser_input">Nom d'usager</label>
                        <input type="text" id="accountUser_input" class="form-control" required>

                        <label for="accountEmail_input">Courriel <span id="accountEmailUnverifiedNotice" style="color: red;">(Non vérifié)</span></label>
                        <input type="text" id="accountEmail_input" class="form-control Email" required>

                        <label for="accountPassword_input">Mot de passe</label>
                        <input type="password" id="accountPassword_input" class="form-control MatchedPassword" matchedPasswordId="accountConfirmation_input" required>

                        <label for="accountConfirmation_input">Confirmation</label>
                        <input type="password" id="accountConfirmation_input" class="form-control" required>

                        <label for="accountAvatarInput">Avatar</label>
                        <div id='accountAvatarInput' class='ImageUploader' defaultImage='images/No_Image.png'
                            waitingImage='images/writing.gif'>
                        </div>
                        <div class="note">Cliquez-Déposez votre avatar</div>
                    </form>
                </div>

                <div id="deleteConfirmationDlg">
                    <p>Êtes-vous sûr de vouloir supprimer votre compte? Cette action est irréversible.</p>
                </div>

                <div id="verificationDlg">
                    <form id="verificationForm">
                        <p>Consultez votre boîte de courriel pour connaître votre code et inscrivez-le ci-dessous</p>
                        <input type="hidden" id="verificationId_input" value="0">
                        <label for="verificationCode_input">Code vérification</label>
                        <input type="text" id="verificationCode_input" class="form-control" required>
                    </form>
                </div>

                <div id="imageDetailsDlg">
                    <a id="details_imageURL" href="images/No_Image.png" target="_blank">
                        <div id="details_image" style="height: 300px; background-image:url('images/No_Image.png'); position:relative"></div>
                    </a>
                    <p id="details_description"></p>
                    <div>
                        <b>Publié par</b>
                        <img id="details_creatorImage" src="images/No_Image.png" class="avatarImg">
                        <b id="details_creatorName"></b>
                    </div>
                    <div>
                        <i>Date de publication:</i>
                        <i id="details_date"></i>
                    </div>
                </div>

                <div id="aboutDlg">
                    <p>Image Manager 2022</p>
                    <p>Fait par: Olivier Bourdel</p>
                </div>

                <div id="messageDlg">
                    <p>Default message</p>
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="js/customValidation.js"></script>
        <script src="js/imageUploader.js"></script>
        <script src="js/accountApi.js"></script>
        <script src="js/api.js"></script>
        <script src="js/date.js"></script>
        <script defer>
            const periodicRefreshPeriod = 15;
            let holdCheckETag = false;
            let currentETag = "";
            let createMode = true;
            let modifyAccount = true;
            let searchCategory = "";
            let searchTitle = "";
            let hideSearchBar = true;
            let imageIdToDelete = 0; // used by confirmDeleteDlg
            let selectedCategory = "";
            let imagesCount = 50;
            let appendCount = 3;
            let previousScrollPosition = 0;
            let appendMode = false;
            let currentToken = null;
            let searchMenuOpen = false;
            let keywords = [];
            let userFilter = "";
            let desc = true;

            init_UI();
            HEAD(checkETag, error);
            setInterval(() => { HEAD(checkETag, error) }, periodicRefreshPeriod * 1000);
            setInterval(() => { initUserSelectList() }, periodicRefreshPeriod * 1000);

            function checkETag(ETag) {
                if (!holdCheckETag && ETag != currentETag) {
                    currentETag = ETag;
                    getImagesList();
                }
            }

            function getImagesList(refresh = true) {
                appendMode = !refresh;
                function prepareQueryString() {
                    let queryString = "";
                    if (appendMode) {
                        queryString = `?${getKeywordQuery()}${getFilterQuery()}sort=Date${desc ? ",desc" : ""}&offset=${Math.trunc(imagesCount / appendCount)}&limit=${appendCount}`;
                        imagesCount += appendCount;
                    } else {
                        queryString = `?${keywords.length != 0 ? getKeywordQuery() : ""}${userFilter ? getFilterQuery() : ""}sort=Date${desc ? ",desc" : ""}&offset=${0}&limit=${imagesCount}`;
                    }
                    return queryString;
                }
                GET_ALL(refreshimagesList, error, prepareQueryString());
            }
            function refreshimagesList(images, ETag) {
                function insertIntoImageList(image, isCreator) {
                    let imageHtml =  
                    $(` 
                        <div class='imageLayout'">
                            <div class='${isCreator ? "imageHeaderCreator" : ""}'>
                                <div class="imageTitle">${image.Title}</div>
                                ${isCreator ?
                                    `<div    class="cmd editCmd  fa fa-pencil-square" 
                                            imageid="${image.Id}" 
                                            title="Editer ${image.Title}" 
                                            data-toggle="tooltip">
                                    </div>
                                    <div    class="cmd deleteCmd fa fa-window-close" 
                                        imageid="${image.Id}" 
                                        title="Effacer ${image.Title}" 
                                        data-toggle="tooltip">
                                    </div>`
                                    : ""
                                }
                            </div>
                            <div>
                                <div    class='image' imageId="${image.Id}"
                                        style="background-image:url('${image.ThumbnailURL}'); position:relative">

                                    ${
                                        isCreator ?
                                            `<div id="accountAvatar" style="position:absolute; left: 0; top: 0;">
                                                <img class="avatarImg" src="${image.Shared ? "images/share.png" : "images/no_share.png"}" title="${image.Shared ? "Partagée" : "Privée"}"
                                                data-toggle="tooltip""><img>
                                            </div>`
                                            : 
                                            `<div id="accountAvatar" style="position:absolute; left: 0; top: 0;">
                                                <img class="avatarImg" src="${image.CreatorThumbnailURL}" title="${image.CreatorName}"
                                                data-toggle="tooltip""><img>
                                            </div>`
                                    }

                                </div>
                            </div>
                            <div class="imageDate">${convertToFrenchDate(parseInt(image.Date))}</div>
                        </div>
                    `)
                    $("#imagesList").append(imageHtml);

                    $(imageHtml).find(".image").click(function(e){
                        openImageDetails(image.Id);
                    });
                }
                currentETag = ETag;
                previousScrollPosition = $(".scrollContainer").scrollTop();
                if (!appendMode) $("#imagesList").empty();

                if (appendMode && images.length == 0)
                    imagesCount -= appendCount;

                for (let image of images) {
                    let isCreator;
                    if(currentToken){
                        isCreator = image.UserId == currentToken.UserId;
                    }else{
                        isCreator = false;
                    }

                    if(image.Shared || isCreator){
                        insertIntoImageList(image, isCreator);
                    }
                }

                $(".scrollContainer").scrollTop(previousScrollPosition);
                $(".editCmd").off();
                $(".deleteCmd").off();
                $(".showMore").off();
                $(".editCmd").click(e => { editimage(e) });
                $(".deleteCmd").click(e => { deleteimage(e) });

                $('[data-toggle="tooltip"]').tooltip();
            }

            function error(status) {
                let errorMessage = "";
                switch (status) {
                    case 0:
                        errorMessage = "Le service ne répond pas";
                        break;
                    case 401:
                        errorMessage = "Requête non autorisée";
                        break;
                    case 400:
                    case 422:
                        errorMessage = "Requête invalide";
                        break;
                    case 404:
                        errorMessage = "Service ou données introuvables";
                        break;
                    case 409:
                        errorMessage = "Conflits de données: Hyperlien existe déjà";
                        break;
                    case 500:
                        errorMessage = "Erreur interne du service";
                        break;
                    default:
                        errorMessage = "Une erreur est survenue";
                        break;
                }
                $("#errorMessage").text(errorMessage);
                $("#errorDlg").dialog('open');
            }

            function newImage() {
                holdCheckETag = true;
                createMode = true;
                // resetimageForm();
                ImageUploader.imageRequired('image', true);
                $("#imageDlg").dialog('option', 'title', "Ajout d'image");
                $("#imageDlgOkBtn").text("Ajouter");
                $("#imageDlg").dialog('open');
            }
            function editimage(e) {
                holdCheckETag = true;
                createMode = false;
                GET_ID(e.target.getAttribute("imageid"), imageToForm, error);
                ImageUploader.imageRequired('image', false);
                $("#imageDlg").dialog('option', 'title', "Modification d'image");
                $("#imageDlgOkBtn").text("Modifier");
                $("#imageDlg").dialog('open');
            }

            function openImageDetails(id){
                holdCheckETag = true;
                GET_ID(id, imageToDetails, error);
                $("#imageDetailsDlg").dialog('open');
            }
            function deleteimage(e) {
                holdCheckETag = true;
                imageIdToDelete = e.target.getAttribute("imageid")
                GET_ID(
                    imageIdToDelete,
                    image => {
                        $("#confirmationMessage").html("Voulez-vous vraiment effacer l'image <br><b>" + image.Title + "</b>?")
                    },
                    error
                );
                holdCheckETag = true;
                $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
                $("#confirmDeleteDlgOkBtn").text("Effacer");
                $("#confirmDeleteDlg").dialog('open');
            }
            // function resetimageForm() {
            //     $("#Id_input").val("0");
            //     $("#GUID_input").val("");
            //     $("#date_input").val(Date.now());
            //     $("#title_input").val("");
            //     $("#description_input").val("");
            //     ImageUploader.resetImage('image');
            // }
            function imageFromForm() {
                if ($("#imageForm")[0].checkValidity()) {
                    let image = {
                        Id: parseInt($("#Id_input").val()),
                        GUID: $("#GUID_input").val(),
                        Title: $("#title_input").val(),
                        Description: $("#description_input").val(),
                        ImageData: ImageUploader.getImageData('image'),
                        Date: parseInt($("#date_input").val()),
                        UserId: currentToken.UserId,
                        Shared: $('#shared_input').prop('checked')
                    };
                    return image;
                } else {
                    $("#imageForm")[0].reportValidity()
                }
                return false;
            }
            function imageToForm(image) {
                $("#Id_input").val(image.Id);
                $("#GUID_input").val(image.GUID);
                $("#date_input").val(image.Date);
                //$("#date_input").val(Date.now());
                $("#title_input").val(image.Title);
                $("#description_input").val(image.Description);
                $("#shared_input").prop("checked", image.Shared);
                ImageUploader.setImage('image', image.OriginalURL);
            }

            function imageToDetails(image){
                $("#imageDetailsDlg").dialog('option', 'title', image.Title);
                $("#details_imageURL").prop("href",image.OriginalURL);
                $("#details_image").css("background-image", `url("${image.OriginalURL}")`);
                $("#details_description").text(image.Description);
                $("#details_date").text(convertToFrenchDate(parseInt(image.Date)));
                $("#details_creatorImage").attr("src",image.CreatorOriginalURL);
                $("#details_creatorName").text(image.CreatorName);
            }
            
            //LOGIN

            function openLogin() {
                holdCheckETag = true;
                $("#loginDlg").dialog('open');
            }
            
            function loginErrorHandler(errorCode){
                let errorMessage = null;
                switch(errorCode){
                    case 480: //unverified 
                        errorMessage = "Unverified";
                        break;
                    case 481: //user not found
                        errorMessage = "No user with the following email";
                        break;
                    case 482: //wrong password
                        errorMessage = "Wrong password";
                        break;
                    default:
                        error(errorCode);
                        break;
                }

                if(errorMessage != null){
                    $("#errorMessage").text(errorMessage);
                    $("#errorDlg").dialog('open');
                }
            }

            // function resetloginform() {
            //     $("#loginEmail_input").val("");
            //     $("#loginPassword_input").val("");
            //     $("#loginErrorMsg").text("");
            // }

            function GetLoginInfo(){
                let loginInfo = {
                    Email: $("#loginEmail_input").val(),
                    Password: $("#loginPassword_input").val(),
                    Remember: $("#loginRememberMe_input").prop('checked')
                };

                return loginInfo;
            }

            function loginUser(user){
                setAccountUI(user);

                $(".loggedOut").hide();
                $(".loggedIn").show();

                getImagesList();
            }

            function logoutAccount(){
                currentToken = undefined;
                localStorage.removeItem("token");

                $(".loggedIn").hide();
                $('.loggedOut').show();

                getImagesList();
            }

            //Account
            function accountFromForm() {
                if ($("#accountForm")[0].checkValidity()) {

                    let account = {
                        Id: parseInt($("#accountId_input").val()),
                        Name: $("#accountUser_input").val(),
                        Email:$("#accountEmail_input").val(),
                        Password:$("#accountPassword_input").val(),
                        AvatarGUID:$("#accountAvatarGuid_input").val(),
                        ImageData: ImageUploader.getImageData('accountAvatarInput')
                    };

                    return account;
                } else {
                    $("#accountForm")[0].reportValidity()
                }
                return false;
            }

            function accountToForm(user){
                $("#accountId_input").val(user.Id);
                $("#accountUser_input").val(user.Name);
                $("#accountEmail_input").val(user.Email);
                $("#accountAvatarGuid_input").val(user.AvatarGUID);
                ImageUploader.setImage('accountAvatarInput', user.AvatarURL);

                if(user.VerifyCode == "unverified"){
                    $("#accountEmailUnverifiedNotice").show();
                }else{
                    $("#accountEmailUnverifiedNotice").hide();
                }

                // $("accountPassword_input")
                // $("accountConfirmation_input")

            }

            //Modify Account
            function openAccountModification(user){
                holdCheckETag = true;

                $("#accountDlg").dialog('option', 'title', "Modifier son compte");
                $("#accountOkBtn").text("Modifier");

                ImageUploader.imageRequired('accountAvatarInput', false);
                $("#accountPassword_input").prop("required", false);
                $("#accountConfirmation_input").prop("required", false);

                accountToForm(user);

                modifyAccount = true;
                $("#accountDeleteBtn").show();

             
                $("#accountDlg").dialog('open');
            }

            function modificationSuccess(){
                GET_USER(currentToken.UserId,setModifications,error)
            }

            function setModifications(user){
                if(checkEmailChange(user)){
                    openVerficiation(user);
                }else{
                    displayMessageDialog("Modification réussi", "Vos informations ont été changées");
                }

                getImagesList();
                setAccountUI(user);
            }

            function checkEmailChange(user){
                console.log(user);
                return user.VerifyCode != "verified";
            }

            //Register
            function openRegister() {
                holdCheckETag = true;

                $("#accountDlg").dialog('option', 'title', "Création de compte");
                $("#accountOkBtn").text("Créer");

                ImageUploader.imageRequired('accountAvatarInput', true);
                $("#accountPassword_input").prop("required", true);
                $("#accountConfirmation_input").prop("required", true);

                modifyAccount = false;
                $("#accountId_input").val(0),
                $("#accountAvatarGuid_input").val(0),
                $("#accountEmailUnverifiedNotice").hide();
                $("#accountDeleteBtn").hide();

                $("#accountDlg").dialog('open');
            }

            function registerError(errorCode){
                let errorMessage = null;
                switch(errorCode){
                    case 409:
                        errorMessage = "Cet email est déjà utilisé."
                        break;
                    default:
                        error(errorCode);
                        break;
                }

                if(errorMessage != null){
                    $("#errorMessage").text(errorMessage);
                    $("#errorDlg").dialog('open');
                }
            }

            //Verification
            function openVerficiation(user){
                $("#verificationId_input").val(user.Id);
                $("#verificationDlg").dialog('open');
            }

            function verifyFromForm(){
                let verification = {
                    Id : $("#verificationId_input").val(),
                    Code : $("#verificationCode_input").val()
                }

                return verification;
            }

            function verificationSuccess(){
                closeAllDialogs();
                displayMessageDialog("Vérification réussie", "Votre compte est désormais vérifié");
            }

            function verificationErrorHandler(errorCode){
                let errorMessage = null;
                switch(errorCode){
                    case 480:
                        errorMessage = "Le code entré est incorrect";
                        break;
                    default:
                        error(errorCode);
                        break;
                }

                if(errorMessage != null){
                    $("#errorMessage").text(errorMessage);
                    $("#errorDlg").dialog('open');
                }
            }

            //Delete Acccount
            function removeAccountSuccess(){
                closeAllDialogs();

                logoutAccount();
                localStorage.removeItem("token");

                getImagesList();
                initUserSelectList();

                displayMessageDialog("Suppression du compte réussie","Votre compte a été supprimé");
            }

            //Search
            function searchImages(){
                let splitKeywords = $("#keywords_input").val().split(' ');
                splitKeywords = splitKeywords[0] == "" ? [] : splitKeywords;
                keywords = splitKeywords;
                let userId = $("#userFilter_input").val();
                userFilter = userId == "all" ? "" : userId;

                getImagesList();

                if(splitKeywords.length != 0){
                    let sessionKeywords;
                    if(sessionStorage.keywords){
                        sessionKeywords = sessionStorage.getItem("keywords").split(';');
                    }else{
                        sessionKeywords = [];
                    }

                    for(let keyword of splitKeywords){
                        if(!sessionKeywords.includes(keyword)){
                            sessionKeywords.push(keyword);
                        }
                    }
                    sessionStorage.setItem("keywords", sessionKeywords.join(';'));

                    setKeywordsInList();
                }
            }

            function setKeywordsInList(){
                if(sessionStorage.keywords){
                    $("#keywordList").empty();
                    let sessionKeywords = sessionStorage.keywords.split(';');
                    for(let keyword of sessionKeywords){
                        $("#keywordList").append(`<option value=${keyword}></option>`);
                    }
                }
            }

            function getKeywordQuery(){
                let query = ""
                if(keywords.length != 0){
                    query = `keywords=${keywords.join(" ")}&`;
                }
                return query;
            }

            function getFilterQuery(){
                let query = ""
                if(userFilter){
                    query = `UserId=${userFilter}&`;
                }
                return query;
            }

            function initUserSelectList(){
                $("#userFilter_input").empty();
                GET_USERID_WITH_IMAGES(function(userIds){
                    for(let userId of userIds){
                        GET_USER(userId.UserId,addUserSelectOption,error);
                    }
                },error);
            }

            function addUserSelectOption(user){
                $("#userFilter_input").append(`<option value="${user.Id}">${user.Name}</option>`);
            }

            function toggleImageOrder(){
                desc = !desc;

                if(desc){
                    $("#sortCmd").attr("class",$("#sortCmd").attr("class").replace("asc","desc"));
                }else{
                    $("#sortCmd").attr("class",$("#sortCmd").attr("class").replace("desc","asc"));
                }

                getImagesList();
            }

            function toggleSearchMenu(){
                searchMenuOpen = !searchMenuOpen;

                if(searchMenuOpen){
                    $("#searchMenu").show();
                    $("#searchMenuCmd").attr("class",$("#searchMenuCmd").attr("class").replace("plus","minus"));
                }else{
                    $("#searchMenu").hide();
                    $("#searchMenuCmd").attr("class",$("#searchMenuCmd").attr("class").replace("minus","plus"));
                }
            }
            
            //UI
            function resetDialogsOnClose(){
                $("[id$='Dlg']").dialog({
                    close : function(e){
                        let targetId = $(e.target).attr("id");

                        $(`#${targetId} form`).each((i, element) => {                                     
                            element.reset();
                        });

                        $(`#${targetId}`).find("input:hidden").each((i, element) => {                                   
                            $(element).val('');
                        });

                        $(`#${targetId} .ImageUploader`).each((i, element) => {                                     
                            ImageUploader.resetImage($(element).attr("id"));
                        })
                    }
                });
            }

            function setAccountUI(user){
                $("#accountImg").attr("src", user.AvatarURL);
                $("#accountName").html(user.Name);
            }

            function closeAllDialogs(){
                $("[id$='Dlg']").dialog('close');
            }

            function displayMessageDialog(title, message){
                $("#messageDlg").dialog('option', 'title', title);
                $("#messageDlg").html(`<p>${message}</p>`);
                $("#messageDlg").dialog('open');
            }

            function init_UI() {
                if(localStorage.token){
                    currentToken = JSON.parse(localStorage.token);
                    GET_USER(currentToken.UserId, loginUser, error);
                }else{
                    logoutAccount();
                }

                initUserSelectList();

                $("#searchMenuCmd").click(toggleSearchMenu);
                $("#searchCmd").click(searchImages);
                $("#sortCmd").click(toggleImageOrder);
                $('#logo').click(function(){$('#aboutDlg').dialog('open')});

                $("#newImageCmd").click(newImage);

                $("#imageDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "imageDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let image = imageFromForm();
                            let imageData = {
                                image : image,
                                token : currentToken
                            }
                            if (image) {
                                if (createMode) {
                                    imageData.image.Date = Date.now();
                                    POST(imageData, getImagesList, error);
                                    $(".scrollContainer").scrollTop(0);
                                }
                                else
                                    PUT(imageData, getImagesList, error);
                                // resetimageForm();
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#imageDetailsDlg").dialog({
                    title: "ImageDetails",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 1000, minWidth: 1000, maxWidth: 2000,
                    height: 600, minHeight: 600, maxHeight: 1000,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#confirmDeleteDlg").dialog({
                    title: "Attention!",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "confirmDeleteDlgOkBtn",
                        text: "Oui",
                        click: function () {
                            holdCheckETag = false;
                            if (imageIdToDelete)
                                var deleteInfo = {
                                    id : imageIdToDelete,
                                    token : currentToken
                                }
                                DELETE(deleteInfo, getImagesList, error);
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });
                
                $("#loginCmd").click(openLogin)

                $("#loginDlg").dialog({
                    title: "Se connecter",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500,
                    height: "auto",
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "loginOkBtn",
                        text: "Connecter",
                        click: function () {
                            holdCheckETag = false;
                            let loginInfo = GetLoginInfo();

                            LOGIN(loginInfo, (userToken) => { 
                                currentToken = userToken;
                                if(loginInfo.Remember){
                                    localStorage.token = JSON.stringify(currentToken);
                                }else{
                                    localStorage.removeItem("token");
                                }
                                GET_USER(currentToken.UserId,loginUser,error); 
                                $(this).dialog("close");
                            }, 
                            loginErrorHandler);
                        },

                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#registerCmd").click(openRegister);
                $("#modifyAccountCmd").click(function(){ GET_USER(currentToken.UserId, openAccountModification, error) });

                $("#accountDlg").dialog({
                    title: "Création de compte",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: "auto",
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "accountDeleteBtn",
                        text: "Supprimer",
                        click: function () {
                            $("#deleteConfirmationDlg").dialog('open');
                        }
                    },
                    {
                        id: "accountOkBtn",
                        text: "Créer",
                        click: function () {
                            holdCheckETag = false;
                            let account = accountFromForm();
                            if(account){
                                if(modifyAccount){
                                    let modificationInfo = {
                                        "token" : currentToken,
                                        "account" : account
                                    };

                                    MODIFY(modificationInfo,modificationSuccess, error);
                                }else{
                                    REGISTER(account, function(){
                                        let loginInfo = {
                                            Email: account.Email,
                                            Password: account.Password,
                                            Remember: false
                                        }
                                        LOGIN(loginInfo, function(userToken){
                                            currentToken = userToken;
                                            GET_USER(userToken.UserId,loginUser,error);
                                            openVerficiation({ Id : userToken.UserId });
                                        },loginErrorHandler)
                                    }, registerError);
                                }
                            }
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#deleteConfirmationDlg").dialog({
                    title: "Supprimer le compte",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: "auto",
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "confirmDeleteAccountBtn",
                        text: "Confirmer",
                        click: function () {
                            holdCheckETag = false;
                            let deleteInfo = {
                                userId : currentToken.UserId,
                                token: currentToken
                            };

                            REMOVE(deleteInfo, _ => removeAccountSuccess(), error);
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });
                
                $("#verificationDlg").dialog({
                    title: "Vérification",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: "auto",
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "verifyBtn",
                        text: "Vérifier",
                        click: function () {
                            holdCheckETag = false;
                            let verification = verifyFromForm();
                            VERIFY(verification, verificationSuccess, error);
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#messageDlg").dialog({
                    title: "Message",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: "auto",
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "messageOkBtn",
                        text: "Ok",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#disconnectCmd").click(function(){
                    LOGOUT(currentToken.UserId, _ => logoutAccount(), error);
                })
                
                $("#aboutDlg").dialog({
                    title: "À propos",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        text: "Fermer",
                        click: function () {
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#errorDlg").dialog({
                    title: "Erreur...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        text: "Fermer",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });

                resetDialogsOnClose();

                $(".scrollContainer").scroll(function () {
                    if ($(".scrollContainer").scrollTop() + $(".scrollContainer").innerHeight() >= $("#imagesList").height()) {
                        getImagesList(false);
                    }
                });
            }
        </script>

    </body>

</html>